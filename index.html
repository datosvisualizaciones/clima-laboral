<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AUTOEVALUACIÓN EN BUENAS PRÁCTICAS PARA LA MEJORA DE LA CALIDAD EN LOS SERVICIOS DE SALUD</title>
  <link rel="icon" href="logo_favaloro.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --text: #515151;
      --muted: #666666;
      --primary: #003A70;
      --primary-2: #005A87;
      --accent: #EF2B2D;
      --card: #ffffff;
      --border: #e0e0e0;
      --bg: #f6f6f6;
      --shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
    }
    a { color: var(--primary); text-decoration: none; }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border-bottom: 3px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .topbar__inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: -0.02em;
    }
    .brand__logo {
      width: 42px;
      height: 42px;
      border-radius: 8px;
      background: #fff;
      border: 2px solid var(--primary);
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .brand__logo img { width: 100%; height: 100%; object-fit: contain; }
    nav {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
    }
    nav a, nav select {
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.4px;
    }
    nav a:hover { background: var(--bg); color: var(--primary); }
    nav select {
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
    }
    .nav-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0, 58, 112, 0.08);
      color: var(--primary);
      font-weight: 700;
      cursor: pointer;
      border: 1px solid rgba(0, 58, 112, 0.14);
      transition: background 0.15s ease, box-shadow 0.15s ease;
    }
    .nav-chip:hover { background: rgba(0, 58, 112, 0.12); box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
    .profile-menu {
      position: absolute;
      top: 110%;
      right: 0;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.1);
      padding: 8px 0;
      min-width: 180px;
      display: none;
      z-index: 20;
    }
    .profile-menu.open { display: block; }
    .profile-menu button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 10px 14px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
    }
    .profile-menu button:hover { background: var(--bg); }
    .badge {
      background: rgba(0, 58, 112, 0.08);
      color: var(--primary);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .hero {
      background: var(--primary);
      color: #fff;
      padding: 42px 20px;
      box-shadow: inset 0 -3px 0 var(--accent);
    }
    .hero__card {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 10px;
    }
    .hero__title { margin: 0 0 6px; font-size: 30px; font-weight: 700; letter-spacing: -0.01em; }
    .hero__text { margin: 0; max-width: 760px; color: rgba(255,255,255,0.92); line-height: 1.5; }
    .page {
      max-width: 1100px;
      margin: 20px auto 60px;
      padding: 0 20px;
      display: grid;
      gap: 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
    }
    .card__title { margin: 0 0 4px; font-size: 20px; letter-spacing: -0.01em; color: var(--primary); }
    .card__lead { margin: 0 0 12px; color: var(--muted); }
    form { display: grid; gap: 18px; }
    .field {
      display: grid;
      gap: 8px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }
    .field__label {
      font-weight: 600;
      color: var(--text);
      margin: 0;
      line-height: 1.4;
    }
    .field__desc { margin: 0; color: var(--muted); font-size: 14px; }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      transition: border 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(31, 63, 166, 0.15);
    }
    textarea { min-height: 110px; resize: vertical; }
    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .option-pill {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s ease;
      width: 100%;
    }
    .option-pill:hover { border-color: var(--primary); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06); }
    .option-pill input { margin: 0; }
    .section-card {
      margin: 22px 0;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      background: #fff;
    }
    .section-card__header {
      padding: 14px 16px;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      color: #fff;
    }
    .section-card__tag {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      margin-bottom: 6px;
      border: 1px solid #c02022;
    }
    .section-card__title { margin: 0 0 6px; font-size: 21px; color: #fff; }
    .section-card__desc { margin: 0 0 8px; color: rgba(255,255,255,0.9); font-size: 15px; }
    .section-card__note { margin: 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600; }
    .section-card__body {
      padding: 16px;
      background: #fff;
    }

    /* Estilos para las pestañas */
    .tabs-container {
      margin: 22px 0;
    }
    .tabs-header {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 20px;
      overflow-x: auto;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
    }
    .tab-button {
      padding: 12px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      flex-shrink: 0;
      border-radius: 8px 8px 0 0;
      position: relative;
      z-index: 1;
    }
    .tab-button:hover {
      color: var(--primary);
      background: rgba(var(--primary-rgb), 0.1);
    }
    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: #fff;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }
    .tab-content {
      display: none;
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 20px;
      background: #fff;
    }
    .tab-content.active {
      display: block;
    }

    /* Barra de progreso */
    .progress-container {
      margin: 20px 0;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .progress-text {
      font-weight: 700;
      color: var(--primary);
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    button {
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      transition: transform 0.05s ease, box-shadow 0.15s ease, opacity 0.2s;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: var(--shadow);
    }
    .btn-secondary {
      background: var(--primary);
      color: #fff;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(15, 157, 88, 0.08);
      color: var(--success);
      font-weight: 600;
    }
    .status--warning { background: rgba(245, 158, 11, 0.12); color: var(--warning); }
    .status--info { background: rgba(31, 63, 166, 0.08); color: var(--primary); }
    .feedback {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--muted);
      font-weight: 600;
      display: none;
    }
    .feedback--visible { display: block; }
    .hidden { display: none; }
    .locked { opacity: 0.7; pointer-events: none; }
    footer {
      max-width: 1100px;
      margin: 30px auto 60px;
      padding: 0 20px;
      color: var(--muted);
      font-size: 14px;
    }
    @media (max-width: 720px) {
      .topbar__inner { flex-direction: column; align-items: flex-start; }
      .hero__card { padding: 20px; }
      .section-block { padding: 12px; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <div class="brand__logo">
          <img src="logo_favaloro.png" alt="Fundación Favaloro" onerror="this.style.display='none'" />
        </div>
        <div>
          Hospital Universitario Fundación Favaloro
          <div style="font-size:12px; color: var(--muted); font-weight:500;">Departamento de Calidad y Seguridad</div>
        </div>
      </div>
      <nav>
        <div id="section-chip" class="nav-chip" aria-haspopup="true" aria-expanded="false">
          <span>Dimensiones</span>
          <i class="fa-solid fa-chevron-down" aria-hidden="true" style="font-size:12px;"></i>
          <div id="section-menu" class="profile-menu" role="menu">
            <button type="button" role="menuitem" data-section-target="section-1">Estructura</button>
            <button type="button" role="menuitem" data-section-target="section-2">Unidad / área de trabajo</button>
            <button type="button" role="menuitem" data-section-target="section-3">Supervisión</button>
            <button type="button" role="menuitem" data-section-target="section-4">Comunicación</button>
            <button type="button" role="menuitem" data-section-target="section-5">Reporte de eventos</button>
          </div>
        </div>
        <div id="user-chip" class="nav-chip hidden" aria-haspopup="true" aria-expanded="false">
          <span id="user-chip-text">Usuario</span>
          <i class="fa-solid fa-chevron-down" aria-hidden="true" style="font-size:12px;"></i>
          <div id="profile-menu" class="profile-menu" role="menu">
            <button id="logout-btn" type="button" role="menuitem">Cerrar sesión</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="hero__card">
      <h1 class="hero__title">Encuesta sobre Seguridad en Servicios de Salud</h1>
      <p class="hero__text">
        Complete el cuestionario: puede guardar y retomarlo más tarde. Una vez enviado, no podrá editarse. Todas las respuestas se registran de forma anónima y se usarán solo con fines de mejora interna.
      </p>
    </div>
  </section>

  <main class="page">
    <section id="login-card" class="card">
      <h2 class="card__title">Inicio de sesión</h2>
      <p class="card__lead">Use las credenciales compartidas para acceder.</p>
      <form id="login-form">
        <div class="field">
          <label class="field__label" for="username">Usuario</label>
          <input id="username" name="username" type="text" autocomplete="username" placeholder="usuariofavaloro" required />
        </div>
        <div class="field">
          <label class="field__label" for="password">Contraseña</label>
          <input id="password" name="password" type="password" autocomplete="current-password" placeholder="********" required />
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Ingresar</button>
        </div>
        <div id="login-error" class="feedback"></div>
      </form>
    </section>

    <section id="formulario" class="card hidden">
       <div class="actions" style="justify-content: flex-end; align-items: center;">
         <div id="status-chip" class="badge hidden" aria-hidden="true">Borrador editable</div>
       </div>
      <form id="survey-form" aria-label="Cuestionario de clima laboral">
        <div class="progress-container">
          <div class="progress-header">
            <span>Progreso de la encuesta</span>
            <span class="progress-text" id="progress-percentage">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
        </div>
        <div id="questions"></div>
        <div class="actions">
          <button id="save-draft" type="button" class="btn-secondary">Guardar borrador</button>
          <button id="submit-final" type="button" class="btn-primary">Enviar respuesta</button>
        </div>
        <div id="form-feedback" class="feedback"></div>
      </form>
    </section>

  </main>

  <footer>
    Rosario Maidana.
  </footer>

  <script>
    // --- Configuracion ---
    const SHEETS_WEBAPP_URL = '/api.php'; // endpoint PHP+MySQL en el mismo host
    const AUTH_KEY = 'clima-laboral-auth';
    const USERS = {
      acaputi: 'acaputi',
      rmaidana: 'rmaidana',
    };
    const LOCAL_KEY_PREFIX = 'clima-laboral-draft-';

    // --- Datos de preguntas ---
    const agreeOptions = [
      { value: '1', label: 'Muy en desacuerdo' },
      { value: '2', label: 'En desacuerdo' },
      { value: '3', label: 'Ni de acuerdo ni en desacuerdo' },
      { value: '4', label: 'De acuerdo' },
      { value: '5', label: 'Muy de acuerdo' },
      { value: '9', label: 'No aplica o no sabe' },
    ];
    const freqOptions = [
      { value: '1', label: 'Nunca' },
      { value: '2', label: 'Rara vez' },
      { value: '3', label: 'Algunas veces' },
      { value: '4', label: 'La mayoría de las veces' },
      { value: '5', label: 'Siempre' },
      { value: '9', label: 'No aplica o no sabe' },
    ];

    const sections = [
      {
        title: 'Estructura',
        desc: 'Piense en su "unidad" como el área de trabajo, departamento o área clínica del hospital donde pasa la mayor parte de su tiempo de trabajo.',
        questions: [
          { id: 'q1', text: '¿Cuál es su cargo en este hospital?', type: 'text' },
          { id: 'q2', text: '¿Cuál es su unidad o área de trabajo principal en este hospital?', type: 'text' },
        ],
      },
      {
        title: 'Unidad / área de trabajo',
        desc: '¿Qué tan de acuerdo o en desacuerdo está usted con las siguientes afirmaciones sobre su unidad/área de trabajo?',
        questions: [
          { id: 'q3', text: 'En esta unidad, trabajamos en equipo de manera eficiente', type: 'scale', options: agreeOptions },
          { id: 'q4', text: 'En esta unidad, tenemos suficiente personal para hacer todo el trabajo', type: 'scale', options: agreeOptions },
          { id: 'q5', text: 'El personal en esta unidad trabaja más horas de lo que es mejor para el cuidado del paciente', type: 'scale', options: agreeOptions },
          { id: 'q6', text: 'Esta unidad revisa periódicamente los procesos de trabajo para determinar si se necesita hacer cambios para mejorar la seguridad del paciente', type: 'scale', options: agreeOptions },
          { id: 'q7', text: 'Esta unidad se sostiene con personal no estable de la institución', type: 'scale', options: agreeOptions },
          { id: 'q8', text: 'En esta unidad, el personal siente que sus errores son considerados en su contra', type: 'scale', options: agreeOptions },
          { id: 'q9', text: 'Cuando se reporta un incidente en esta unidad, se siente que la persona está siendo denunciada y no el problema', type: 'scale', options: agreeOptions },
          { id: 'q10', text: 'Cuando hay mucho trabajo, el personal en esta unidad se ayuda mutuamente', type: 'scale', options: agreeOptions },
          { id: 'q11', text: 'El comportamiento irrespetuoso de quienes trabajan en esta unidad genera problemas', type: 'scale', options: agreeOptions },
          { id: 'q12', text: 'Cuando el personal comete errores, esta unidad se enfoca en aprender en vez de buscar quién tiene la culpa', type: 'scale', options: agreeOptions },
          { id: 'q13', text: 'El ritmo de trabajo en esta unidad es tan acelerado que impacta negativamente en la seguridad del paciente', type: 'scale', options: agreeOptions },
          { id: 'q14', text: 'En esta unidad, los cambios para mejorar la seguridad de los pacientes se evalúan para ver qué tan efectivos son', type: 'scale', options: agreeOptions },
          { id: 'q15', text: 'En esta unidad falta apoyo al personal involucrado en errores de seguridad de paciente', type: 'scale', options: agreeOptions },
          { id: 'q16', text: 'Esta unidad permite que los mismos problemas de seguridad del paciente sigan ocurriendo', type: 'scale', options: agreeOptions },
        ],
      },
      {
        title: 'Supervisión',
        desc: '¿Qué tan de acuerdo o en desacuerdo está usted con las siguientes afirmaciones sobre su unidad/área de trabajo?',
        questions: [
          { id: 'q17', text: 'Mi superior considera seriamente las sugerencias del personal para mejorar la seguridad del paciente', type: 'scale', options: agreeOptions },
          { id: 'q18', text: 'Mi superior quiere que trabajemos más rápido durante las horas de más trabajo, incluso si eso significa no seguir los procedimientos adecuadamente, lo cual podría poner en riesgo la seguridad del paciente', type: 'scale', options: agreeOptions },
          { id: 'q19', text: 'Mi superior toma medidas para solucionar problemas que le han sido comunicados respecto a la seguridad del paciente', type: 'scale', options: agreeOptions },
        ],
      },
      {
        title: 'Comunicación',
        desc: 'Seleccione una sola opción por afirmación.',
        questions: [
          { id: 'q20', text: 'Se nos informa sobre los errores que se cometen en esta unidad', type: 'scale', options: freqOptions },
          { id: 'q21', text: 'Cuando se cometen errores en esta unidad, hablamos sobre las maneras para evitar que vuelvan a ocurrir', type: 'scale', options: freqOptions },
          { id: 'q22', text: 'En esta unidad, se nos informa sobre los cambios que se hacen basados en reportes de eventos', type: 'scale', options: freqOptions },
          { id: 'q23', text: 'En esta unidad, el personal dice si ve algo que podría afectar negativamente el cuidado del paciente', type: 'scale', options: freqOptions },
          { id: 'q24', text: 'Cuando el personal de esta unidad ve a alguien con mayor autoridad haciendo algo que no es seguro para los pacientes, lo dice', type: 'scale', options: freqOptions },
          { id: 'q25', text: 'Cuando el personal de esta unidad habla, las personas que tienen más autoridad escuchan sus preocupaciones sobre la seguridad del paciente', type: 'scale', options: freqOptions },
          { id: 'q26', text: 'En esta unidad, el personal tiene miedo de hacer preguntas cuando algo no parece estar bien', type: 'scale', options: freqOptions },
        ],
      },
      {
        title: 'Reporte de eventos de seguridad del paciente',
        desc: 'Seleccione una sola opción por afirmación.',
        questions: [
          { id: 'q27', text: 'Si se descubre un error y se corrige antes de que afecte al paciente, ¿con qué frecuencia se reporta?', type: 'scale', options: freqOptions },
          { id: 'q28', text: 'Si un error afecta al paciente y podría haberle causado daño pero no fue así, ¿con qué frecuencia se reporta?', type: 'scale', options: freqOptions },
          { id: 'q29', text: 'En los últimos 12 meses, ¿cuántos eventos relacionados con la seguridad del paciente ha reportado usted?', type: 'scale', options: [
            { value: 'Ninguno', label: 'Ninguno' },
            { value: '1 a 2', label: '1 a 2' },
            { value: '3 a 5', label: '3 a 5' },
            { value: '6 a 10', label: '6 a 10' },
            { value: '11 o más', label: '11 o más' },
          ]},
        ],
      },
    ];

    // --- Estado ---
    let currentUser = null;
    let finalSubmitted = false;

    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const loginCard = document.getElementById('login-card');
    const formCard = document.getElementById('formulario');
    const userChip = document.getElementById('user-chip');
    const userChipText = document.getElementById('user-chip-text');
    const profileMenu = document.getElementById('profile-menu');
    const sectionChip = document.getElementById('section-chip');
    const sectionMenu = document.getElementById('section-menu');
    const statusChip = document.getElementById('status-chip');
    const questionsContainer = document.getElementById('questions');
    const surveyForm = document.getElementById('survey-form');
    const feedback = document.getElementById('form-feedback');
    const saveDraftBtn = document.getElementById('save-draft');
    const submitFinalBtn = document.getElementById('submit-final');
    const logoutBtn = document.getElementById('logout-btn');
    const progressFill = document.getElementById('progress-fill');
    const progressPercentage = document.getElementById('progress-percentage');

    function calculateProgress() {
      let answered = 0;
      let total = 29; // Total de preguntas q1-q29

      for (let i = 1; i <= total; i++) {
        const questionId = `q${i}`;
        const element = document.getElementById(questionId);

        if (element) {
          if (element.type === 'text' || element.type === 'textarea') {
            if (element.value.trim() !== '') {
              answered++;
            }
          } else if (element.type === 'radio') {
            // Para radio buttons, verificar si hay uno seleccionado en el grupo
            const radioGroup = document.querySelector(`input[name="${questionId}"]:checked`);
            if (radioGroup) {
              answered++;
            }
          } else if (element.tagName === 'SELECT') {
            if (element.value !== '') {
              answered++;
            }
          }
        }
      }

      return { answered, total, percentage: Math.round((answered / total) * 100) };
    }

    function updateProgressBar() {
      const progress = calculateProgress();
      const percentage = progress.percentage;

      progressFill.style.width = `${percentage}%`;
      progressPercentage.textContent = `${percentage}%`;

      // Cambiar color basado en el progreso
      if (percentage < 25) {
        progressFill.style.background = '#dc3545'; // Rojo
      } else if (percentage < 50) {
        progressFill.style.background = '#fd7e14'; // Naranja
      } else if (percentage < 75) {
        progressFill.style.background = '#ffc107'; // Amarillo
      } else if (percentage < 100) {
        progressFill.style.background = '#20c997'; // Verde claro
      } else {
        progressFill.style.background = '#28a745'; // Verde
      }
    }

    function renderSections() {
      questionsContainer.innerHTML = '';

      // Crear contenedor de pestañas
      const tabsContainer = document.createElement('div');
      tabsContainer.className = 'tabs-container';

      // Crear header de pestañas
      const tabsHeader = document.createElement('div');
      tabsHeader.className = 'tabs-header';

      // Crear contenido de pestañas
      const tabsContent = document.createElement('div');
      tabsContent.className = 'tabs-content';

      sections.forEach((section, idx) => {
        // Crear botón de pestaña
        const tabButton = document.createElement('button');
        tabButton.className = 'tab-button';
        tabButton.textContent = `${section.title}`;
        tabButton.dataset.tab = `tab-${idx + 1}`;
        if (idx === 0) tabButton.classList.add('active');
        tabsHeader.appendChild(tabButton);

        // Crear contenido de pestaña
        const tabContent = document.createElement('div');
        tabContent.className = 'tab-content';
        tabContent.id = `tab-${idx + 1}`;
        if (idx === 0) tabContent.classList.add('active');

        // Crear header de la pestaña
        const header = document.createElement('div');
        header.className = 'section-card__header';
        const tag = document.createElement('div');
        tag.className = 'section-card__tag';
        tag.textContent = `Dimensión ${idx + 1}`;
        const h = document.createElement('h3');
        h.className = 'section-card__title';
        h.textContent = `${section.title}`;
        const desc = document.createElement('p');
        desc.className = 'section-card__desc';
        desc.textContent = section.desc;
        header.appendChild(tag);
        header.appendChild(h);
        header.appendChild(desc);
        if (section.note) {
          const note = document.createElement('p');
          note.className = 'section-card__note';
          note.textContent = section.note;
          header.appendChild(note);
        }
        tabContent.appendChild(header);

        // Crear body de la pestaña
        const body = document.createElement('div');
        body.className = 'section-card__body';

        let questionCounter = 0;
        section.questions.forEach(q => {
          const number = ++questionCounter;
          const field = document.createElement('div');
          field.className = 'field';
          const label = document.createElement('label');
          label.className = 'field__label';
          label.htmlFor = q.id;
          label.textContent = `${number}. ${q.text}`;
          field.appendChild(label);

          let inputNode;
          if (q.type === 'text') {
            inputNode = document.createElement('input');
            inputNode.type = 'text';
            inputNode.id = q.id;
            inputNode.name = q.id;
          } else if (q.type === 'textarea') {
            inputNode = document.createElement('textarea');
            inputNode.id = q.id;
            inputNode.name = q.id;
          } else if (q.type === 'select') {
            inputNode = document.createElement('select');
            inputNode.id = q.id;
            inputNode.name = q.id;
            const empty = document.createElement('option');
            empty.value = '';
            empty.textContent = 'Seleccione...';
            inputNode.appendChild(empty);
            q.options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.label;
              inputNode.appendChild(option);
            });
          } else if (q.type === 'scale') {
            const optionsGrid = document.createElement('div');
            optionsGrid.className = 'options-grid';
            q.options.forEach(opt => {
              const labelOpt = document.createElement('label');
              labelOpt.className = 'option-pill';
              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.name = q.id;
              radio.value = opt.value;
              labelOpt.appendChild(radio);
              const span = document.createElement('span');
              span.textContent = opt.label;
              labelOpt.appendChild(span);
              optionsGrid.appendChild(labelOpt);
            });
            inputNode = optionsGrid;
          }

          field.appendChild(inputNode);
          body.appendChild(field);
        });

        tabContent.appendChild(header);
        tabContent.appendChild(body);
        tabsContent.appendChild(tabContent);
      });

      tabsContainer.appendChild(tabsHeader);
      tabsContainer.appendChild(tabsContent);
      questionsContainer.appendChild(tabsContainer);

      // Agregar funcionalidad de pestañas usando delegación de eventos
      tabsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-button')) {
          e.preventDefault();
          const button = e.target;
          const tabId = button.dataset.tab;


          // Remover clase active de todos los botones y contenidos
          tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          tabsContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

          // Agregar clase active al botón clickeado y su contenido
          button.classList.add('active');
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
            tabContent.classList.add('active');
          }
        }
      });
    }


    function setFeedback(message, tone = 'info') {
      feedback.textContent = message;
      feedback.classList.add('feedback--visible');
      feedback.style.borderColor = tone === 'error' ? 'rgba(220,38,38,0.4)' : varColor(tone);
      feedback.style.color = tone === 'error' ? '#b91c1c' : '#0f172a';
    }
    function clearFeedback() {
      feedback.textContent = '';
      feedback.classList.remove('feedback--visible');
    }
    function varColor(tone) {
      if (tone === 'success') return 'rgba(15,157,88,0.4)';
      if (tone === 'warning') return 'rgba(245,158,11,0.5)';
      return 'rgba(31,63,166,0.4)';
    }

    function serializeAnswers() {
      const data = {};
      sections.forEach(section => {
        section.questions.forEach(q => {
          const name = q.id;
          if (q.type === 'scale') {
            const checked = surveyForm.querySelector(`input[name="${name}"]:checked`);
            data[name] = checked ? checked.value : '';
          } else {
            const control = surveyForm.querySelector(`#${name}`);
            data[name] = control ? control.value.trim() : '';
          }
        });
      });
      return data;
    }

    function fillForm(values) {
      if (!values) return;
      sections.forEach(section => {
        section.questions.forEach(q => {
          const val = values[q.id] || '';
          if (q.type === 'scale') {
            const radio = surveyForm.querySelector(`input[name="${q.id}"][value="${val}"]`);
            if (radio) radio.checked = true;
          } else {
            const control = surveyForm.querySelector(`#${q.id}`);
            if (control) control.value = val;
          }
        });
      });
    }

    function localKey(user) {
      return `${LOCAL_KEY_PREFIX}${user}`;
    }

    function loadLocalDraft(user) {
      const raw = localStorage.getItem(localKey(user));
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function saveLocalDraft(user, data) {
      localStorage.setItem(localKey(user), JSON.stringify(data));
    }

    function applySession(user) {
      currentUser = user;
      userChipText.textContent = `Usuario: ${user}`;
      userChip.classList.remove('hidden');
      userChip.setAttribute('aria-expanded', 'false');
      loginCard.classList.add('hidden');
      formCard.classList.remove('hidden');
      const stored = loadLocalDraft(user);
      surveyForm.classList.remove('locked');
      saveDraftBtn.disabled = false;
      submitFinalBtn.disabled = false;
      finalSubmitted = false;
      if (stored && stored.answers) {
        fillForm(stored.answers);
        statusChip.textContent = 'Borrador cargado';
        updateProgressBar();
      } else {
        surveyForm.reset();
        statusChip.textContent = 'Borrador editable';
      }
    }

    function clearSession() {
      currentUser = null;
      finalSubmitted = false;
      surveyForm.reset();
      surveyForm.classList.remove('locked');
      saveDraftBtn.disabled = false;
      submitFinalBtn.disabled = false;
      userChip.classList.add('hidden');
      profileMenu.classList.remove('open');
      loginCard.classList.remove('hidden');
      formCard.classList.add('hidden');
      statusChip.textContent = 'Borrador editable';
      localStorage.removeItem(AUTH_KEY);
    }

    function handleLogin(evt) {
      evt.preventDefault();
      clearFeedback();
      loginError.classList.remove('feedback--visible');
      const user = (document.getElementById('username').value || '').trim().toLowerCase();
      const pass = (document.getElementById('password').value || '').trim();
      if (!user || USERS[user] !== pass) {
        loginError.textContent = 'Usuario o contraseña inválidos.';
        loginError.classList.add('feedback--visible');
        return;
      }
      localStorage.setItem(AUTH_KEY, user);
      applySession(user);
    }

    function setLocked() {
      finalSubmitted = true;
      surveyForm.classList.add('locked');
      saveDraftBtn.disabled = true;
      submitFinalBtn.disabled = true;
      statusChip.textContent = 'Respuesta enviada';
      statusChip.style.background = 'rgba(15,157,88,0.15)';
      statusChip.style.color = '#0f9d58';
      setFeedback('Gracias por completar este cuestionario. Sus respuestas han sido registradas.', 'success');
    }

    async function sendToSheets(payload) {
      if (!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.startsWith('REEMPLAZAR')) {
        throw new Error('Configurar SHEETS_WEBAPP_URL con el Web App de Apps Script.');
      }
      const resp = await fetch(SHEETS_WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        body: JSON.stringify(payload),
      });
      if (!resp.ok) throw new Error('No se pudo guardar en Sheets (HTTP ' + resp.status + ').');
      try { return await resp.json(); } catch { return {}; }
    }

    async function handleSave(status) {
      if (!currentUser) {
        setFeedback('Debe iniciar sesión antes de guardar.', 'error');
        return;
      }
      if (finalSubmitted) return;
      const answers = serializeAnswers();
      saveLocalDraft(currentUser, { answers, status });
      const payload = {
        usuario: currentUser,
        estado: status,
        timestamp: new Date().toISOString(),
        respuestas: answers,
      };
      try {
        setFeedback(status === 'borrador' ? 'Guardando borrador...' : 'Enviando respuesta...');
        await sendToSheets(payload);
        if (status === 'borrador') {
          setFeedback('Borrador guardado en Sheets.', 'success');
          statusChip.textContent = 'Borrador guardado';
        } else {
          setLocked();
        }
      } catch (err) {
        setFeedback(err.message || 'No se pudo enviar. Reintente.', 'error');
      }
    }

    function init() {
      renderSections();
      loginForm.addEventListener('submit', handleLogin);
      logoutBtn.addEventListener('click', () => {
        clearSession();
      });
      const sectionJump = document.getElementById('section-jump');
      if (sectionJump) {
        sectionJump.addEventListener('change', () => {
          const target = sectionJump.value;
          if (target) {
            const el = document.getElementById(target);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            sectionJump.value = '';
          }
        });
      }
      userChip.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = profileMenu.classList.contains('open');
        profileMenu.classList.toggle('open', !isOpen);
        userChip.setAttribute('aria-expanded', (!isOpen).toString());
      });
      if (sectionChip) {
        sectionChip.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = sectionMenu.classList.contains('open');
          sectionMenu.classList.toggle('open', !isOpen);
          sectionChip.setAttribute('aria-expanded', (!isOpen).toString());
        });
      }
      document.querySelectorAll('[data-section-target]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-section-target');
          if (target) {
            // Convertir section-X a tab-X para activar la pestaña correspondiente
            const tabId = target.replace('section-', 'tab-');
            const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabButton) {
              tabButton.click(); // Simular click en la pestaña
            }
          }
          sectionMenu.classList.remove('open');
          sectionChip.setAttribute('aria-expanded', 'false');
        });
      });
      document.addEventListener('click', (e) => {
        if (profileMenu.classList.contains('open') && !userChip.contains(e.target)) {
          profileMenu.classList.remove('open');
          userChip.setAttribute('aria-expanded', 'false');
        }
        if (sectionMenu && sectionMenu.classList.contains('open') && !sectionChip.contains(e.target)) {
          sectionMenu.classList.remove('open');
          sectionChip.setAttribute('aria-expanded', 'false');
        }
      });
      const storedUser = localStorage.getItem(AUTH_KEY);
      if (storedUser && USERS[storedUser]) {
        applySession(storedUser);
      }
      surveyForm.addEventListener('input', () => {
        if (currentUser && !finalSubmitted) {
          const answers = serializeAnswers();
          saveLocalDraft(currentUser, { answers, status: 'borrador' });
        }
        // Actualizar barra de progreso cuando cambian las respuestas
        updateProgressBar();
      });
      saveDraftBtn.addEventListener('click', () => handleSave('borrador'));
      submitFinalBtn.addEventListener('click', () => handleSave('completo'));

      // Inicializar barra de progreso
      updateProgressBar();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

